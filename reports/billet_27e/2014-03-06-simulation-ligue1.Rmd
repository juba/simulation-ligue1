---                                                                                                                                                                  
layout: post                                                                                                                                                         
title: "Simulation de la fin du championnat de Ligue 1 2013/2014"                                                                                                                                                        
category: posts                                                                                                                                                      
---  


```{r knitr_init, echo=FALSE, results="asis", cache=FALSE}
library(knitr)

## Global options
options(scipen=10000)
options(max.print="70")
options(prompt="R> ")
opts_chunk$set(fig.path="images/2014-03-06-simulation-ligue1/",
               opts_chunk$set(fig.cap = "center"),
               echo=FALSE,
               cache.path="cache/",
               cache=FALSE,
               prompt=TRUE,
               tidy=TRUE,
               highlight=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               background=".95;.95;.95",
               out.format="jekyll",
               dev="png",
               fig.width=9,
               fig.height=7)
opts_knit$set(width=75)
opts_knit$set(base.url="/")
options(knitr.table.format = 'html')
```

```{r load, echo=FALSE, results="hide", cache=FALSE, message=FALSE}
root.dir <- "/home/julien/stats/simulation-ligue1/"
setwd(root.dir)
library(ProjectTemplate)
load.project()
load("cache/table15.RData")
load("cache/table.all.RData")

derniere.journee <- 27
```

# C'est quoi ?

La fin du championnat approchant, les mêmes questions reviennent fréquemment : le
titre est-il déjà joué ? Le 19ème du classement a-t-il encore une chance de rester
en Ligue 1 ? Qui peut encore croire à une place en Champions League ?

On peut apporter des éléments de réponse à ces questions en effectuant une
simulation. Il ne s'agit pas ici de s'écrouler dans la surface en hurlant, mais
plutôt, pour l'ensemble des matchs restant à jouer, de tirer au sort le résultat de la rencontre et de voir au final quels sont les classements obtenus.

La première partie présente la méthode utilisée. Si vous êtes pressés vous
pouvez passer directement aux résultats.

À noter que les [données et le code source utilisés](https://github.com/juba/simulation-ligue1) sont librement téléchargeables.


# Méthode

Toute la question est de savoir comment on tire au sort le résultat d'une rencontre
tout en gardant un minimum de logique sportive, sans quoi ça n'aurait aucun sens.

On regarde d'abord les journées pour lesquelles les résultats sont connus. À partir
des scores des différentes rencontres, on calcule, pour chaque équipe, le pourcentage
de victoires, de nuls et de défaites, à domicile et à l'extérieur. On interprète
alors ces pourcentages en probabilités pour la suite des rencontres : si une équipe
a remporté 70% de ses matchs à domicile jusque-là, on considère que la probabilité
qu'elle remporte un prochain match à domicile est de 7 chances sur 10.

Pour chaque rencontre à venir, on combine alors les probabilités de victoire, nul et
défaite à domicile de l'équipe qui reçoit, et celles de victoire, nul et défaite à
l'extérieur pour l'équipe qui se déplace. Ceci permet de calculer trois nouvelles
probabilités pour la rencontre : celle d'une victoire à domicile, celle d'un nul,
et celle d'une victoire à l'extérieur. 

<div class="alert" style="font-size: 80%;">
<a data-toggle="collapse" data-target="#explications" style="cursor: pointer;">Comment les probabilités sont-elles combinées ?</a>
 <div id="explications" class="collapse">
En pratique les trois probabilités concernant l'issue du match sont calculées de la manière suivante :

<ul>
<li>La probabilité d'une victoire de l'équipe qui reçoit est la moyenne de la probabilité
de victoire à domicile de l'équipe qui reçoit, et de celle de défaite à l'extérieur de
l'équipe qui se déplace.</li>
<li>À l'inverse, la probabilité d'une victoire à l'extérieur est la moyenne entre la
probabilité de victoire à l'extérieur de l'équipe qui se déplace, et celle de défaite
à domicile de l'équipe qui reçoit.</li>
<li>Enfin, la probabilité d'un match nul est la moyenne entre la probabilité d'un nul
à domicile pour l'équipe qui reçoit, et celle d'un nul à l'extérieur pour l'équipe
qui se déplace</li>
</ul>

L'avantage est que la somme de ces trois probabilités fait toujours 1, ce qui est
toujours bien pour des probabilités...
 </div>
</div>

On utilise alors ces probabilités pour tirer aléatoirement le résultat du match.
On fait cette opération pour tous les matchs à venir, et on peut alors calculer le 
nombre de points et le classement simulés pour chaque équipe au soir de la 38ème
journée.


# Limites

Il ne s'agit évidemment que d'une méthode possible parmi d'autres. L'avantage est
qu'elle prend en compte si le match est joué à domicile ou à l'extérieur, ainsi
que le niveau des équipes, mesuré par leurs résultats précédents. 

Mais cette approche a évidemment plusieurs limites :

* elle "fige" le niveau d'une équipe à celui de la dernière journée connnue, et ne peut
évidemment pas prendre en compte des dynamiques propres à chaque équipe qui 
interviendraient pendant les journées à venir.

* elle ne prend pas en compte les événements tels que les blessures ou le fait que
certaines équipes jouent plus de matchs que d'autres.

* elle ne tient pas compte des aspects tactiques ou du fait que le jeu de certaines
équipes convient plus ou moins bien à d'autres.


# Résultats

Grâce à cette méthode on peut simuler une fin de championnat, et obtenir un classement
final possible. Cela n'a aucun intérêt vu l'aspect très aléatoire du résultat. On peut
par contre simuler 1000 fins de championnats, et regarder les différents classements
obtenus. C'est déjà beaucoup plus intéressant, et c'est donc ce qu'on a fait.

Ici on prend en compte les résultats obtenus lors des 15 dernières journées précédant
la dernière en date (c'est-à-dire la `r derniere.journee`ème), et on a effectué 
1000 simulations de la fin du championnat, c'est-à-dire des résultats de toutes les
rencontres restantes. Pour chaque équipe, on a donc 1000 totaux de point différents
obtenus et 1000 classements à la fin du championnat.

## Moyenne des points

On peut regarder d'abord le nombre de points obtenus en moyenne par chaque équipe
lors des 1000 simulations, et le classement qui en découle :

<i class="icon-question-sign icon-2x icon-popover pull-left" data-toggle="popover"
data-original-title="Lecture" data-content="Sur les 1000 simulations, le Paris SG 
a obtenu en moyenne 83,48 points">
</i>

```{r tab_moy, results='asis'}
tab <- table15
moy <- tab %.% group_by(eq) %.% summarize(moyenne=mean(points))
moy <- moy[order(moy$moyenne, decreasing=TRUE),]
moy$classement <- 1:20
tab$eq <- factor(tab$eq, levels=rev(moy$eq))
setnames(moy, c("Équipe", "Moyenne", "Classement"))
kable(moy)
```

La moyenne n'est qu'un résumé, elle n'est donc pas très intéressante car elle 
écrase toutes les variations : quels ont été le nombre minimal et le nombre maximal
de points obtenus par chaque équipe ? Quels étaient les nombres de points les plus
fréquents ?


## Variation du nombre de points obtenus

On peut représenter graphiquement les résultats des 1000 simulations tout en préservant 
la variabilité, par exemple sous forme de [boîtesà moustaches](https://www.tns-ilres.com/cms/Home/WikiStat/La-boite-a-moustaches) :

```{r graph_points, cache=TRUE}
ggplot(data=tab) +
    geom_boxplot(aes(x=eq,y=points)) +
    scale_x_discrete("Équipe") +
    scale_y_continuous("Nombre de points") +
    coord_flip() +
    theme(text = element_text(size=17))
```

Ou sous forme de "graphe en violons". Dans ce cas, la "patate" est d'autant plus
haute que la fréquence du nombre de points correspondant est élevée.

```{r graph_pointsv, cache=TRUE}
ggplot(data=tab) +
    geom_violin(aes(x=eq,y=points)) +
    scale_x_discrete("Équipe") +
    scale_y_continuous("Nombre de points") +
    coord_flip() +
    theme(text = element_text(size=17))
```

Quelle conclusion tirer de ces graphiques ? 

* *A priori* les deux premières places sont jouées. Pour que Paris ne soit pas 
champion il faudrait que l'équipe ait une performance exceptionnellement basse, 
et que Monaco ait un nombre de points très élevé. Et il est encore moins probable
que Monaco soit rattrapé.

* La troisième place se joue entre Lille et Saint-Étienne, avec un léger avantage
pour les Verts.

* Pour la relégation, si Ajaccio est définitivement en Ligue 2, Valenciennes et 
Sochaux sont en position très délicates, en concurrence essentiellement avec 
Évian Thonon-Gaillard, les autres équipes étant relativement à l'abri.


## Classement des équipes

On peut aussi regarder les résultats de ces simulations équipe par équipe. Pour
chaque club, on regarde la répartition des classements lors de ces 1000
simulations, et on peut en déduire la probabilité de chaque position obtenue.

C'est ce qu'on représente sur le graphique suivant :

<i class="icon-question-sign icon-2x icon-popover pull-left" data-toggle="popover"
data-original-title="Lecture" data-content="La hauteur de chaque barre représente
la probabilité que le club finisse à cette position en fin de championnat">
</i>

```{r graph_position, fig.height=15}
library(scales)
tab$eq <- factor(tab$eq, levels=rev(levels(tab$eq)))
ggplot(data=tab) +
    geom_bar(aes(x=factor(classement), y=(..count..)/sum(..count..)*20)) +
    facet_grid(eq~.) +
    scale_y_continuous("Pourcentage", labels=percent_format()) +
    scale_x_discrete("Position en fin de championnat") +
    theme(text=element_text(size=16), 
          strip.text.y=element_text(angle=0),
          axis.text.y=element_text(size=9)) 
```

Comment interpréter ce graphique ? 

* Dans les 1000 simulations effectuées, le Paris SG arrive en 1ère position dans 88%
des cas. On peut convertir ce pourcentage en probabilité en disant que Paris a 8,8
chances sur 10 de finir champion.

* De même Monaco a 80% de chances de finir 2ème.

* Pour la troisième place, Saint-Étienne aurait une chance sur deux d'accrocher un tour
préliminaire de Champions League, contre 3 chances sur 10 pour Lille. Marseille n'a
que 7% de chances, et Lyon 2%.

* Pour la relégation, Ajaccio finit relégué dans 100% des simulations, Sochaux a 70% de
chances de descendre en L2, contre un peu plus de 60% pour Valenciennes. À l'inverse,
Évian a 3 chances sur 10 de descendre, Nice 18% de chances et Rennes 10%.


```{r tab_compute, results='asis'}
#library(questionr)
#tapply(tab$classement, tab$eq, freq, exclude=NA)
```



